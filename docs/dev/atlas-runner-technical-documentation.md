# Atlas Runner Technical Documentation

## Architecture Overview

Atlas Runner is a distributed system for managing Minecraft server deployments with the following components:

- **Atlas Runner CLI** (`atlas-runner`): User-facing command-line interface
- **Atlas Runner Daemon** (`atlas-runnerd`): Background service managing server lifecycle
- **Atlas Hub**: Remote service providing pack metadata and blobs
- **Protocol Buffer APIs**: Internal communication protocols

## System Components

### CLI (atlas-runner)

**Location**: `apps/runner-v2/`
**Language**: Rust (Tokio async runtime)
**Purpose**: User interface and daemon communication

#### Key Features
- Command parsing and validation
- Daemon IPC via Unix sockets
- Configuration management
- Interactive prompts for first-run setup

#### Configuration Storage
- Path: `~/.atlas/runnerd/deploy.json`
- Format: JSON with serde serialization
- Fields: Hub URL, pack ID, channel, tokens, runtime settings

### Daemon (atlas-runnerd)

**Location**: `apps/runnerd-v2/`
**Language**: Rust (Tokio async runtime)
**Purpose**: Server lifecycle management and monitoring

#### Key Components

##### Supervisor Module
- **Server Management**: Start/stop/restart Minecraft servers
- **Process Monitoring**: Track server health and auto-restart on crashes
- **Log Aggregation**: Collect stdout/stderr from server processes
- **Update Polling**: Check for pack updates from Atlas Hub

##### IPC Layer
- **Protocol**: Custom framing over Unix domain sockets
- **Requests**: Start, Stop, Status, Logs, RCON commands
- **Events**: Log lines, server state changes

##### State Management
- **Shared State**: Arc<Mutex<ServerState>> for thread-safe access
- **Persistence**: Configuration files, no database required
- **Threading**: Separate threads for IPC, monitoring, updates

### Communication Protocols

#### IPC Protocol

**Location**: `crates/runner-ipc-v2/`
**Format**: Protocol Buffers over framed streams

##### Message Types

###### Requests (Client → Daemon)
```protobuf
message Request {
  oneof payload {
    Ping ping = 1;
    Start start = 2;
    Stop stop = 3;
    Status status = 4;
    LogsTail logs_tail = 5;
    RconExec rcon_exec = 6;
    SaveDeployKey save_deploy_key = 7;
  }
}

message Start {
  string profile = 1;
  map<string, string> env = 2;
}
```

###### Responses (Daemon → Client)
```protobuf
message Response {
  oneof payload {
    Pong pong = 1;
    Started started = 2;
    Stopped stopped = 3;
    Status status = 4;
    LogsTail logs_tail = 5;
    RconResult rcon_result = 6;
    DeployKeySaved deploy_key_saved = 7;
    Error error = 8;
  }
}
```

#### Hub API Protocol

**Location**: `crates/atlas-client/`
**Format**: RESTful HTTP/JSON

##### Endpoints
- `GET /api/packs/{packId}/{channel}/latest` - Get latest build metadata
- `GET /api/packs/{packId}/builds/{buildId}/blob` - Download pack blob
- `GET /api/packs/{packId}/whitelist` - Get player whitelist

### Pack Distribution Format

**Format**: Zstd-compressed Protocol Buffer blob
**Location**: `crates/protocol/`

#### Structure
```protobuf
message DistributionBlob {
  Metadata metadata = 1;
  bytes payload = 2;
}

message Metadata {
  string pack_id = 1;
  string version = 2;
  string minecraft_version = 3;
  string loader = 4;
  repeated Dependency dependencies = 5;
  repeated Filter platform_filters = 6;
  uint64 created_at = 7;
}
```

#### Payload
- Virtual filesystem mapping: relative paths → byte content
- Includes: server JARs, configs, mods, resource packs
- Excludes: generated files (worlds, logs, etc.)

### Provisioning System

**Location**: `crates/runner-provision-v2/`
**Purpose**: Apply pack blobs to server directories

#### Process
1. **Download**: Fetch pack blob from Hub
2. **Decompress**: Zstd decompression
3. **Deserialize**: Parse Protocol Buffer
4. **Apply**: Write files to server directory
5. **Dependencies**: Download and verify external JARs/mods
6. **Launch**: Generate JVM command line

#### JVM Configuration
- **Memory**: `-Xmx{max_ram}m -Xms{max_ram}m`
- **GC**: Default JVM settings
- **Classpath**: Computed from applied JARs
- **Arguments**: Custom server arguments from pack metadata

### RCON Implementation

**Location**: `crates/runner-v2-rcon/`
**Protocol**: Minecraft RCON (TCP-based)

#### Features
- Authentication with password
- Command execution
- Interactive console mode
- Automatic server discovery

### System Integration

#### Unix Signals
- **SIGTERM**: Graceful shutdown (stop server, exit)
- **SIGINT**: Force kill server process

#### Systemd Service
- **Unit File**: Generated by `atlas-runner systemd install`
- **Auto-restart**: Configured for crash recovery
- **User Service**: Runs under user account, not root

#### Directory Structure
```
~/.atlas/runnerd/
├── deploy.json          # Configuration
├── sockets/             # Unix domain sockets
├── runtime/             # Temporary files
└── servers/             # Server instances
    └── default/
        ├── current/     # Active server files
        ├── backups/     # World backups
        └── logs/        # Server logs
```

## Security Considerations

### Authentication
- Deploy tokens stored encrypted in configuration
- Hub communication over HTTPS
- No sensitive data in logs

### Process Isolation
- Daemon runs as user process
- Server processes spawned with restricted permissions
- No root access required

### Network Security
- RCON password authentication
- Configurable RCON port and binding
- Firewall considerations for Minecraft port (25565)

## Performance Characteristics

### Memory Usage
- CLI: Minimal (~10MB)
- Daemon: ~50MB base + server memory
- Pack caching: Reduces network I/O

### CPU Usage
- Idle: <1% CPU
- During updates: Burst during downloads
- Server monitoring: Lightweight polling

### Disk Usage
- Pack blobs: Cached locally (~100MB-1GB per pack)
- Server files: Variable (worlds, logs)
- Logs: Rotated, configurable retention

## Monitoring and Debugging

### Log Levels
- **ERROR**: Critical failures
- **WARN**: Non-critical issues
- **INFO**: Normal operations
- **DEBUG**: Detailed internal state

### Debug Commands
```bash
# View daemon internal logs
atlas-runner daemon-logs --follow

# Check daemon status
atlas-runner ping

# Inspect configuration
cat ~/.atlas/runnerd/deploy.json
```

### Common Issues
- **Socket connection failures**: Check daemon is running
- **Permission denied**: Verify file permissions
- **Pack download failures**: Check network and tokens
- **Memory issues**: Adjust RAM limits

## Development

### Building
```bash
# Full workspace
cargo build --release

# Specific components
cargo build -p runner-v2
cargo build -p runnerd-v2
```

### Testing
```bash
# Unit tests
cargo test

# Integration tests
cargo test --test integration
```

### Code Organization
- **CLI**: User commands and prompts
- **Daemon**: Background services and IPC
- **Shared**: Protocol definitions and utilities
- **Provisioning**: Pack application logic

### Contributing
- Follow Rust coding standards
- Add tests for new features
- Update documentation
- Use conventional commits