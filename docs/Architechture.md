# Technical Architecture Specification: Atlas
**Version:** 3.0 (Comprehensive)
**System Purpose:** High-performance, Git-centric Minecraft modpack distribution with tiered invitation access and binary-optimized hydration.

---

## 1. System Overview
Atlas is a platform for managing and distributing Minecraft modpacks. It utilizes a **Source-in-Git, Distribution-in-Binary** model. 
- **Creators** manage packs via human-readable Git repositories (TOMLs for mods, raw text for configs).
- **GitHub Actions** "compiles" these repositories into a single, optimized binary blob.
- **The Backend** orchestrates user access, version promotion (channels), and file hosting.
- **The Launcher** consumes the binary blob to instantly "hydrate" the game directory and download filtered dependencies.

---

## 2. Component Architecture

### 2.1 Management Hub (Next.js & Vercel)
The central Control Plane of the ecosystem.
*   **Web Dashboard**: Interface for Admins (inviting creators), Creators (managing packs/versions/players), and Players (browsing library).
*   **API Gateway**: RESTful endpoints for the Rust CLI, GitHub Actions, and the Launcher.
*   **Identity Provider**: Manages custom Email/Password authentication with secondary GitHub OAuth linking for repository access.
*   **Release Manager**: Controls the "Channel Pointers" (Dev, Beta, Production) that determine which build is served to which audience.

### 2.2 Builder CLI & CI (Rust & GitHub Actions)
The heavy-compute engine offloaded to GitHubâ€™s infrastructure.
*   **Builder CLI**: A Rust binary used locally by creators (for adding mods/uploading assets) and in CI (for compiling the distribution blob).
*   **Compilation**: The process of walking the Git repo, resolving mod metadata, zips config files, and serializing the result into the distribution format.
*   **Deployment**: CI pushes the resulting blob to the Hub via a secure, pack-specific Deploy Token.

### 2.3 Object Storage (Cloudflare R2 & CDN)
*   **Blob Storage**: Hosts the immutable `.bin` distribution artifacts.
*   **Asset Hosting**: Hosts custom mod JARs or assets uploaded directly by creators that are not available on public platforms (Modrinth/CurseForge).
*   **Egress**: Optimized for zero-egress costs to ensure free distribution.

---

## 3. The Atlas Distribution Format (.apack)
To eliminate HTTP overhead, a specific version is represented by a single **Zstd-compressed Protobuf3** blob.

### 3.1 Metadata & Manifest
*   **Global Info**: Pack ID, Version String, Minecraft Version, and Loader (Fabric/Forge/Neo).
*   **Dependency Manifest**: List of external JARs with:
    *   Direct URLs (Modrinth/CurseForge/Custom).
    *   Integrity hashes (SHA-1/SHA-256).
    *   **Platform Filters**: Logic flags for OS-specific mod exclusion (Windows/Linux/macOS).

### 3.2 Embedded Payload (Byte-Map)
*   A virtual filesystem mapping relative paths (e.g., `config/server.properties`) to raw byte arrays.
*   Contains all text-based scripts, configs, and small data files.
*   **Compression**: Zstd applies massive compression ratios across the entire Byte-Map, as text-based configs are highly repetitive.

---

## 4. Identity & Access Management (IAM)

### 4.1 Tiered Role Hierarchy
1.  **System Admin**: Manages the platform; generates **Creator Invite Codes**.
2.  **Pack Creator**: Registers via Admin code; links GitHub. Can create packs, generate **Player Access Links**, and manage the build pipeline.
3.  **Player**: Registers via Creator's access link. Authorized only to play packs they have "joined."

### 4.2 Security Architecture
*   **Linked Identity**: A User (Email/Pass) can link a GitHub account. The backend stores the GitHub Access Token (encrypted) to manage Pack repos.
*   **Deploy Tokens**: Unique high-entropy strings per pack. Injected into GitHub Secrets to authorize the CI builder to push new versions to the Hub.
*   **Channel Permissions**: Players can only see/access "Beta" or "Dev" channels if the Creator has granted them explicit permission or provided a channel-specific key.

---

## 5. Version & Release Management

### 5.1 Immutable Builds vs. Mutable Channels
*   **Build**: A static artifact (`.bin` file) generated by a Git commit. Builds never change.
*   **Channel**: A named pointer (Production, Beta, Dev).
*   **Auto-Assignment**: Every push to Git creates a Build and automatically points the **Dev** channel to it.

### 5.2 Release Control (Web UI)
*   **Promotion**: The act of updating a Channel pointer (e.g., pointing the "Production" channel to the ID of a "Beta" build).
*   **Reversion/Rollback**: Instantly updating a Channel pointer to a previous Build ID.
*   **Ledger**: A complete history of every build received from CI, including commit messages and timestamps.

---

## 6. Technical Workflows

### 6.1 Pack Creation & Deployment
1.  **Import**: Creator selects a GitHub repo via the Hub. Hub injects secrets and a `deploy.yml` workflow.
2.  **Commit**: Creator pushes TOML files and configs to Git.
3.  **Build**: GitHub Actions runs the Builder CLI; generates the compressed `.bin` blob.
4.  **Ingestion**: CLI POSTs the blob to the Hub. Hub saves it to R2 and updates the "Dev" channel pointer.

### 6.2 Launcher Hydration
1.  **Sync**: Launcher requests the active Build for the user's selected channel.
2.  **Download**: Launcher fetches the single `.bin` blob.
3.  **Decompression**: Launcher performs in-memory Zstd decompression and Protobuf3 deserialization.
4.  **Hydration**:
    *   **Text Files**: The Byte-Map is iterated; files are written directly to the game directory.
    *   **Dependencies**: The Manifest is iterated; the Launcher checks the current OS against filters, verifies hashes, and downloads JARs only as needed.
5.  **Execution**: Launcher invokes the JVM with the calculated classpath.

---

## 7. Infrastructure Specifications

*   **Backend**: Next.js (Edge-compatible) on Vercel.
*   **Database**: Managed PostgreSQL (storing users, permissions, pack metadata, and build history).
*   **Storage**: Cloudflare R2 for blobs and assets.
*   **Serialization**: Protobuf3 (Rust native, schema-driven, forward-compatible).
*   **Compression**: Zstd (Level 19+ for distribution blobs).
*   **CLI/Launcher**: Rust (optimized for low memory usage and high-speed hashing).
