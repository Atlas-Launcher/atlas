name: cli-installer-release

on:
  push:
    tags:
      - "cli-v*"

permissions:
  contents: write

jobs:
  build-installers:
    name: Build unsigned CLI installer (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: startsWith(github.ref_name, 'cli-v')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
          shared-key: cli-installer-${{ matrix.os }}

      - name: Build CLI
        run: cargo build --release -p atlas-cli

      - name: Build unsigned Linux .deb installer
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          VERSION="${GITHUB_REF_NAME#cli-v}"
          MACHINE="$(uname -m)"
          case "${MACHINE}" in
            x86_64) DEB_ARCH="amd64" ;;
            aarch64|arm64) DEB_ARCH="arm64" ;;
            *) DEB_ARCH="${MACHINE}" ;;
          esac

          PKG_DIR="staging/atlas-cli-installer-linux-${DEB_ARCH}"
          mkdir -p "${PKG_DIR}/DEBIAN" "${PKG_DIR}/usr/local/bin"
          install -m 0755 target/release/atlas "${PKG_DIR}/usr/local/bin/atlas"

          cat > "${PKG_DIR}/DEBIAN/control" <<EOF
          Package: atlas-cli
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${DEB_ARCH}
          Maintainer: Atlas <noreply@atlas.dev>
          Description: Atlas CLI for modpack build and deploy workflows.
          EOF

          dpkg-deb --build "${PKG_DIR}" "dist/atlas-cli-installer-linux-${DEB_ARCH}.deb"

      - name: Build unsigned macOS .pkg installer
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          VERSION="${GITHUB_REF_NAME#cli-v}"
          MACHINE="$(uname -m)"
          ROOT_DIR="staging/pkgroot"
          mkdir -p "${ROOT_DIR}/usr/local/bin"
          install -m 0755 target/release/atlas "${ROOT_DIR}/usr/local/bin/atlas"

          # Intentionally unsigned package build: no --sign flag.
          pkgbuild \
            --root "${ROOT_DIR}" \
            --identifier "dev.atlas.cli" \
            --version "${VERSION}" \
            --install-location "/" \
            "dist/atlas-cli-installer-macos-${MACHINE}.pkg"

      - name: Build unsigned Windows installer bundle
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null

          $arch = $env:PROCESSOR_ARCHITECTURE.ToLowerInvariant()
          switch ($arch) {
            "amd64" { $arch = "x64" }
            "x86_64" { $arch = "x64" }
            "arm64" { $arch = "arm64" }
            default { }
          }

          $bundleDir = "staging/atlas-cli-installer-windows-$arch"
          New-Item -ItemType Directory -Path $bundleDir -Force | Out-Null

          Copy-Item "target/release/atlas.exe" "$bundleDir/atlas.exe"

          @"
          param(
            [string]`$InstallDir = "`$env:ProgramFiles\Atlas CLI"
          )

          New-Item -ItemType Directory -Path `$InstallDir -Force | Out-Null
          Copy-Item "`$PSScriptRoot\atlas.exe" "`$InstallDir\atlas.exe" -Force
          Write-Host "Installed atlas.exe to `$InstallDir"
          Write-Host "Add this directory to PATH if it is not already configured."
          "@ | Set-Content -Path "$bundleDir/install.ps1" -Encoding UTF8

          @"
          Atlas CLI installer bundle

          Run install.ps1 in PowerShell (as Administrator if needed) to install atlas.exe.
          "@ | Set-Content -Path "$bundleDir/README.txt" -Encoding UTF8

          Compress-Archive -Path "$bundleDir/*" -DestinationPath "dist/atlas-cli-installer-windows-$arch.zip" -Force

      - name: Upload unsigned installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: atlas-cli-installer-${{ matrix.os }}
          path: dist/atlas-cli-installer-*
          if-no-files-found: error

  release-installers:
    name: Release unsigned CLI installers
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'cli-v')
    needs: [build-installers]
    steps:
      - name: Parse version
        id: tag
        run: echo "version=${GITHUB_REF_NAME#cli-v}" >> "$GITHUB_OUTPUT"

      - name: Download installer artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/installers

      - name: Publish installer assets to release
        uses: softprops/action-gh-release@v2
        with:
          name: Atlas CLI v${{ steps.tag.outputs.version }}
          tag_name: ${{ github.ref_name }}
          files: dist/installers/**/atlas-cli-installer-*
          fail_on_unmatched_files: true
