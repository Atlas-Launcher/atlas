name: cli-release

on:
  push:
    tags:
      - "cli-v*"

permissions:
  contents: read

concurrency:
  group: cli-release-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_PROFILE_RELEASE_DEBUG: "0"
  CARGO_INCREMENTAL: "0"
  CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER: lld-link
  CARGO_TARGET_AARCH64_PC_WINDOWS_MSVC_LINKER: lld-link
  RUSTC_WRAPPER: sccache
  SCCACHE_GHA_ENABLED: "true"
  SCCACHE_IGNORE_SERVER_IO_ERROR: "1"

jobs:
  build-cli:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: startsWith(github.ref_name, 'cli-v')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Ensure lld-link is available (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $lld = Get-Command lld-link -ErrorAction SilentlyContinue
          if (-not $lld) {
            choco install llvm --yes --no-progress
            $llvmBin = Join-Path $env:ProgramFiles "LLVM\\bin"
            if (Test-Path $llvmBin) {
              Add-Content -Path $env:GITHUB_PATH -Value $llvmBin
              $env:Path = "$llvmBin;$env:Path"
            }
          }

          $lld = Get-Command lld-link -ErrorAction SilentlyContinue
          if (-not $lld) {
            throw "lld-link not found after attempting LLVM installation."
          }
          Write-Host "lld-link found at $($lld.Source)"

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
          shared-key: atlas-rust-${{ runner.os }}-workspace
          cache-all-crates: true
          cache-on-failure: true

      - name: Install mold linker (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Build CLI (Linux)
        if: runner.os == 'Linux'
        run: RUSTFLAGS="-C link-arg=-fuse-ld=mold" cargo build --release -p atlas-cli

      - name: Build CLI (Non-Linux)
        if: runner.os != 'Linux'
        run: cargo build --release -p atlas-cli

      - name: Stage CLI artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          BIN_PATH="target/release/atlas"
          FILE_NAME="atlas-${{ runner.os }}-${{ runner.arch }}"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            BIN_PATH="target/release/atlas.exe"
            FILE_NAME="${FILE_NAME}.exe"
          fi

          cp "${BIN_PATH}" "dist/${FILE_NAME}"
          ls -lah dist

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: atlas-cli-${{ matrix.os }}
          path: dist/atlas-*
          if-no-files-found: error
          retention-days: 1

  build-installers:
    name: Build CLI installers (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: startsWith(github.ref_name, 'cli-v')
    needs: [build-cli]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: atlas-cli-${{ matrix.os }}
          path: dist/cli

      - name: Sign Windows CLI binary
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          WIN_B64_PFX: ${{ secrets.WIN_B64_PFX }}
          WIN_PFX_PASSWORD: ${{ secrets.WIN_PFX_PASSWORD }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:WIN_B64_PFX)) {
            throw "WIN_B64_PFX secret is required to sign Windows CLI artifacts."
          }
          if ([string]::IsNullOrWhiteSpace($env:WIN_PFX_PASSWORD)) {
            throw "WIN_PFX_PASSWORD secret is required to sign Windows CLI artifacts."
          }

          $binPath = "dist/cli/atlas-Windows-${{ runner.arch }}.exe"
          if (-not (Test-Path $binPath)) {
            throw "Expected Windows CLI artifact not found: $binPath"
          }

          $pfxPath = Join-Path $env:RUNNER_TEMP "windows-codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WIN_B64_PFX))

          $signtool = (Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\*\x64\signtool.exe" |
            Sort-Object FullName -Descending |
            Select-Object -First 1).FullName
          if (-not $signtool) {
            throw "signtool.exe not found in Windows SDK."
          }

          & $signtool sign `
            /f $pfxPath `
            /p $env:WIN_PFX_PASSWORD `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            $binPath

      - name: Verify Windows CLI binary signature
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $binPath = "dist/cli/atlas-Windows-${{ runner.arch }}.exe"
          $signature = Get-AuthenticodeSignature $binPath
          if ($signature.Status -ne "Valid") {
            throw "Invalid signature status '$($signature.Status)' for $binPath"
          }

      - name: Build unsigned Linux .deb installer
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          VERSION="${GITHUB_REF_NAME#cli-v}"

          MACHINE="$(uname -m)"
          case "${MACHINE}" in
            x86_64) DEB_ARCH="amd64" ;;
            aarch64|arm64) DEB_ARCH="arm64" ;;
            *) DEB_ARCH="${MACHINE}" ;;
          esac

          PKG_DIR="staging/atlas-cli-installer-linux-${DEB_ARCH}"
          mkdir -p "${PKG_DIR}/DEBIAN" "${PKG_DIR}/usr/local/bin"

          install -m 0755 "dist/cli/atlas-Linux-${{ runner.arch }}" "${PKG_DIR}/usr/local/bin/atlas"

          cat > "${PKG_DIR}/DEBIAN/control" <<EOF
          Package: atlas-cli
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${DEB_ARCH}
          Maintainer: Atlas <noreply@atlas.dev>
          Description: Atlas CLI for modpack build and deploy workflows.
          EOF

          dpkg-deb --build "${PKG_DIR}" "dist/atlas-cli-installer-linux-${DEB_ARCH}.deb"

      - name: Build unsigned macOS .pkg installer
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          VERSION="${GITHUB_REF_NAME#cli-v}"
          MACHINE="$(uname -m)"

          # Find downloaded binary; artifact naming is atlas-${runner.os}-${runner.arch}.
          BIN="$(find dist/cli -maxdepth 1 -type f -name 'atlas-*' ! -name '*.exe' | head -n 1)"
          if [[ -z "${BIN}" ]]; then
            echo "No macOS CLI binary found in dist/cli." >&2
            ls -lah dist/cli || true
            exit 1
          fi
          chmod +x "$BIN"

          ROOT_DIR="staging/pkgroot"
          mkdir -p "${ROOT_DIR}/usr/local/bin"
          install -m 0755 "$BIN" "${ROOT_DIR}/usr/local/bin/atlas"

          pkgbuild \
            --root "${ROOT_DIR}" \
            --identifier "dev.atlas.cli" \
            --version "${VERSION}" \
            --install-location "/" \
            "dist/atlas-cli-installer-macos-${MACHINE}.pkg"

      - name: Build unsigned Windows installer bundle (zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null

          $arch = $env:PROCESSOR_ARCHITECTURE.ToLowerInvariant()
          switch ($arch) {
            "amd64" { $arch = "x64" }
            "x86_64" { $arch = "x64" }
            "arm64" { $arch = "arm64" }
            default { }
          }

          $bundleDir = "staging/atlas-cli-installer-windows-$arch"
          New-Item -ItemType Directory -Path $bundleDir -Force | Out-Null

          Copy-Item "dist/cli/atlas-Windows-${{ runner.arch }}.exe" "$bundleDir/atlas.exe"

          @"
          param(
            [string]`$InstallDir = "`$env:ProgramFiles\Atlas CLI"
          )

          New-Item -ItemType Directory -Path `$InstallDir -Force | Out-Null
          Copy-Item "`$PSScriptRoot\atlas.exe" "`$InstallDir\atlas.exe" -Force
          Write-Host "Installed atlas.exe to `$InstallDir"
          Write-Host "Add this directory to PATH if it is not already configured."
          "@ | Set-Content -Path "$bundleDir/install.ps1" -Encoding UTF8

          @"
          Atlas CLI installer bundle

          Run install.ps1 in PowerShell (as Administrator if needed) to install atlas.exe.
          "@ | Set-Content -Path "$bundleDir/README.txt" -Encoding UTF8

          Compress-Archive -Path "$bundleDir/*" -DestinationPath "dist/atlas-cli-installer-windows-$arch.zip" -Force

      - name: Upload installer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: atlas-cli-installers-${{ matrix.os }}
          path: dist/atlas-cli-installer-*
          if-no-files-found: error
          retention-days: 1

  release:
    name: Release CLI
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'cli-v')
    needs: [build-cli, build-installers]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Parse version
        id: tag
        run: echo "version=${GITHUB_REF_NAME#cli-v}" >> "$GITHUB_OUTPUT"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Build Atlas publish manifest
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .atlas-release
          manifest=".atlas-release/cli-files.txt"
          : > "${manifest}"
          binary_count=0
          installer_count=0

          map_os() {
            local lower="$1"
            if [[ "${lower}" == *windows* ]]; then
              echo "windows"
            elif [[ "${lower}" == *darwin* || "${lower}" == *macos* ]]; then
              echo "macos"
            elif [[ "${lower}" == *linux* ]]; then
              echo "linux"
            else
              return 1
            fi
          }

          map_arch() {
            local lower="$1"
            if [[ "${lower}" == *arm64* || "${lower}" == *aarch64* ]]; then
              echo "arm64"
            else
              echo "x64"
            fi
          }

          while IFS= read -r file; do
            base="$(basename "${file}")"
            lower="$(echo "${base}" | tr '[:upper:]' '[:lower:]')"

            os="$(map_os "${lower}")" || continue
            arch="$(map_arch "${lower}")"

            installer_count=$((installer_count + 1))
            echo "${file}|${os}|${arch}|installer|${base}" >> "${manifest}"
          done < <(find dist -type f -name 'atlas-cli-installer-*')

          while IFS= read -r file; do
            base="$(basename "${file}")"
            lower="$(echo "${base}" | tr '[:upper:]' '[:lower:]')"

            os="$(map_os "${lower}")" || continue
            arch="$(map_arch "${lower}")"

            binary_count=$((binary_count + 1))
            echo "${file}|${os}|${arch}|binary|${base}" >> "${manifest}"
          done < <(find dist -type f -name 'atlas-*' ! -name 'atlas-cli-installer-*')

          test -s "${manifest}"
          if [[ "${binary_count}" -eq 0 ]]; then
            echo "No raw CLI binaries were discovered for publishing." >&2
            exit 1
          fi
          if [[ "${installer_count}" -eq 0 ]]; then
            echo "No CLI installers were discovered for publishing." >&2
            exit 1
          fi
          echo "Discovered ${binary_count} binary artifact(s) and ${installer_count} installer artifact(s)."
          cat "${manifest}"

      - name: Publish CLI to Atlas Distribution API
        uses: ./.github/actions/atlas-release
        with:
          atlas_base_url: ${{ secrets.ATLAS_HUB_URL }}
          atlas_app_deploy_token: ${{ secrets.ATLAS_APP_DEPLOY_TOKEN }}
          product: cli
          version: ${{ steps.tag.outputs.version }}
          channel: stable
          files_manifest: .atlas-release/cli-files.txt
